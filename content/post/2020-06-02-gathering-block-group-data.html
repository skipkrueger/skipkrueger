---
title: Gathering Block Group Data
author: Skip Krueger
date: '2020-06-02'
slug: gathering-block-group-data
categories: []
tags: []
draft: false
image: img/portfolio/p1.png
showonlyimage: False
weight: 1
description: Using TIDYCENSUS to collect Census data for Block Groups
---



<div id="using-tidycensus-to-collect-census-data-for-block-groups" class="section level5">
<h5>Using TIDYCENSUS to collect Census data for Block Groups</h5>
<p>This code downloads basic Census data for BLOCK GROUPS. It’s more convoluted than it should be. There is a work-around, but it is clunky.This is a Census issue, not an R issue or <code>tidycensus</code> issue.</p>
</div>
<div id="you-can-check-the-discussion-at-this-link." class="section level5">
<h5><a href="https://github.com/walkerke/tidycensus/issues/136" target="_blank">You can check the discussion at this link</a>.</h5>
<p><BR></p>
</div>
<div id="libraries-needed-and-numbering-format" class="section level5">
<h5>Libraries needed and numbering format</h5>
<p><BR></p>
<pre class="r"><code>library(tidycensus);library(tidyverse);library(tibble);library(data.table);
library(dplyr);library(lubridate);library(ggplot2);library(scales)

options(scipen=999)</code></pre>
<p><BR></p>
</div>
<div id="census-tables-available" class="section level5">
<h5>Census Tables Available</h5>
<p>The first trick is figuring out which tables we need from the Census tables. The <code>tidycensus</code> library makes this super-easy. But once you load the list of tables, you have to scroll through that table and figure out the exact table you need. Note that not all tables in the list are available at the Block Group level for all time points. But you can search the list if you view the table and then use the search tool on the top right of the list.</p>
<pre class="r"><code>v17 &lt;- load_variables(2018, &quot;acs5&quot;, cache = TRUE)
view(v17)</code></pre>
<p><BR></p>
</div>
<div id="downloading-the-data" class="section level5">
<h5>Downloading the Data</h5>
<p>Now comes the ugly part. The Census Bureau only makes the block group data available by county.</p>
<p>So, you have to define every state and county you want a variable for, and then download it BY COUNTY. This can be iterated, but it is slow, at least the way I did it. There is supposedly an IPUMS way to download this for the whole US, but for this analysis, I just downloaded the block groups for Texas. I could only do this for one variable at a time, so I just ran the following code for each Census Table I wanted to download, and created a data.table for each. So, the code below was run for each variable, and the name of the data.table was changed for each variable I downloaded.</p>
<p>The IPUMS workaround is supposed to be better, but I haven’t tried it.</p>
</div>
<div id="you-may-want-to-check-into-it-here." class="section level5">
<h5><a href="https://developer.ipums.org/docs/get-started/" target="_blank">You may want to check into it here</a>.</h5>
<p>For this Texas data, each variable download took several minutes. But I was working on my home laptop over wifi, so you can probably achieve significantly faster download times.</p>
<pre class="r"><code># Define the states you want to download. 
# Each state adds more time to the download.

my_states &lt;- c(&quot;TX&quot;)

# Add the counties for each of the states.

my_counties &lt;- fips_codes %&gt;%
  filter(state %in% my_states)

# Combines the state list and county list to specify the geographies 
# you want to download.

county_state &lt;- tigris::counties(
  state = my_states,
  cb = TRUE,
  resolution = &quot;20m&quot;,
  year = &quot;2018&quot;,
  class = &quot;sf&quot;
)

# Download the BLOCK GROUP data. 
# Change the table name and variable (Census table) each time.

medfaminc &lt;- map2_dfr(
  .x = county_state$STATEFP,
  .y = county_state$COUNTYFP,
  ~ get_acs(
    geography = &quot;block group&quot;,
    variables = &quot;B19113_001&quot;,
    state = .x,
    county = .y
  )
)</code></pre>
<p><BR></p>
</div>
<div id="cleaning-and-merging-the-data" class="section level5">
<h5>Cleaning and Merging the Data</h5>
<p>For this project, I downloaded:</p>
<ul>
<li>AApop = # of African Americans in block group (B03002_004)</li>
<li>txHispop = # of Hispanics in block group (B03003_003)</li>
<li>txwpop = # of non-Hispanic whites in block group (B03002_003)</li>
<li>txtotpop = # of total population in block group (B02001_001)</li>
<li>txmedinc = median family income of block group (B19113_001)</li>
</ul>
<p>These Census Tables are downloaded as a separate data.table with a long text name and the measurement error, in addition to the geo-id and variable of interest. So, the code below cleans up each data.table a bit and changes the geo-id name in each so that the variables do not have the same name when they are combined.</p>
<p>Since all the data.files are exactly the same length, they can easily be combined with <code>cbind</code>.</p>
<p>The combined data.table is then cleaned up by removing the repetitious geo-id columns, with the remaining geo-id column renamed GEOID.</p>
<pre class="r"><code>AApop &lt;- select(AApop,-c(moe,NAME,variable))
names(AApop)[names(AApop) == &quot;estimate&quot;] &lt;- &quot;AApop&quot;
names(AApop)[names(AApop) == &quot;GEOID&quot;] &lt;- &quot;GEOIDaa&quot;

txHispop &lt;- select(txHispop,-c(moe,NAME,variable))
names(txHispop)[names(txHispop) == &quot;estimate&quot;] &lt;- &quot;Hispop&quot;
names(txHispop)[names(txHispop) == &quot;GEOID&quot;] &lt;- &quot;GEOIDhisp&quot;

txwpop &lt;- select(txwpop,-c(moe,NAME,variable))
names(txwpop)[names(txwpop) == &quot;estimate&quot;] &lt;- &quot;wpop&quot;
names(txwpop)[names(txwpop) == &quot;GEOID&quot;] &lt;- &quot;GEOIDw&quot;

txtotpop &lt;- select(txtotpop,-c(moe,NAME,variable))
names(txtotpop)[names(txtotpop) == &quot;estimate&quot;] &lt;- &quot;totpop&quot;
names(txtotpop)[names(txtotpop) == &quot;GEOID&quot;] &lt;- &quot;GEOIDtot&quot;

txmedinc &lt;- select(txmedinc,-c(moe,NAME,variable))
names(txmedinc)[names(txmedinc) == &quot;estimate&quot;] &lt;- &quot;medinc&quot;
names(txmedinc)[names(txmedinc) == &quot;GEOID&quot;] &lt;- &quot;GEOIDinc&quot;

txbg &lt;- cbind(txtotpop,AApop,txHispop,txwpop,txmedinc)

txbg &lt;- select(txbg,-c(3,5,7,9))
names(txbg)[names(txbg) == &quot;GEOIDtot&quot;] &lt;- &quot;GEOID&quot;</code></pre>
<p><BR></p>
</div>
<div id="creating-some-ratios-and-categories" class="section level5">
<h5>Creating some ratios and categories</h5>
<p>I am interested in block groups with minority majorities and with low incomes, so I create som variables with percentages and then create categories based on those percentages.</p>
<p>Then I can create one categorical variable for block groups that have:</p>
<ul>
<li>African American population majority</li>
<li>Hispanic population majority</li>
<li>White population majority</li>
<li>All other block groups</li>
</ul>
<pre class="r"><code>txbg$AAper &lt;- txbg$AApop/txbg$totpop*100
txbg$wper &lt;- txbg$wpop/txbg$totpop*100
txbg$Hper &lt;- txbg$Hispop/txbg$totpop*100

txbg$hiscat &lt;- if_else(txbg$Hper&gt;50,1,0)  
txbg$aacat &lt;- if_else(txbg$AAper&gt;50,1,0)
txbg$wcat &lt;- if_else(txbg$wper&gt;50,1,0)

summary(txbg$medinc)  
txbg$inccat &lt;- if_else(txbg$medinc&gt;63965,1,0)

txbg$cat &lt;- &quot;Other&quot;
txbg$cat &lt;- if_else(txbg$aacat==1,&quot;African American&quot;,txbg$cat)
txbg$cat &lt;- if_else(txbg$hiscat==1,&quot;Hispanic&quot;,txbg$cat)
txbg$cat &lt;- if_else(txbg$wcat==1,&quot;White&quot;,txbg$cat)
txbg$cat &lt;- as.factor(txbg$cat)
txbg$cat &lt;- as.character(txbg$cat)</code></pre>
<p><BR></p>
</div>
<div id="final-clean-up" class="section level5">
<h5>Final clean up</h5>
<p>Convert the data to a tibble and drop the cases with missing data.</p>
<pre class="r"><code>txbg &lt;- as_tibble(txbg)
txbg &lt;- na.omit(txbg)

write.csv(txbg,&quot;txbg.csv&quot;)</code></pre>
<p><BR></p>
</div>
<div id="counting-cases-of-the-categories" class="section level5">
<h5>Counting cases of the categories</h5>
<p>Using <code>group_by</code> allows me to make a nice plot of the counts of the categories. I save that as a high-res png file.</p>
<pre class="r"><code>txgp1 &lt;- txbg %&gt;%
  group_by(cat) %&gt;%
  summarize(incount = n())

p1 &lt;-   ggplot(txgp1,aes(x=reorder(cat,incount),y=incount,fill=cat))+
  geom_bar(stat=&quot;Identity&quot;,show.legend = F)+
  labs(x = &quot;Racial Majority of Block Group&quot;, y = &quot;Number of Block Groups&quot;) +
  geom_text(aes(label=comma(incount)),vjust=1.5,size=3,color=&quot;white&quot;,fontface = &quot;bold&quot;)+
  theme(axis.text.y = element_blank(),axis.ticks.y = element_blank())
plot(p1 + theme(axis.text.y = element_blank()),type=&quot;cairo&quot;)

ggsave(filename=&quot;p1.png&quot;, plot=p1, device=&quot;png&quot;,
       height=5, width=5, units=&quot;in&quot;, dpi=500)</code></pre>
<p><BR>
<img src="p1.png" />
<BR></p>
</div>
<div id="median-family-income-by-category" class="section level5">
<h5>Median Family Income by category</h5>
<p>It’s a little odd to take the average of the Median Family Income for all the block groups in each category, but it’s just for evaluation purposes at this point.</p>
<pre class="r"><code>txgp2 &lt;- txbg %&gt;%
  group_by(cat) %&gt;%
  summarize(medinc = mean(medinc))

p2 &lt;-   ggplot(txgp2,aes(x=cat,y=medinc,fill=cat))+
  geom_bar(stat=&quot;Identity&quot;,show.legend = F)+
  labs(x = &quot;Racial Majority of Block Group&quot;, y = &quot;Median Family Income&quot;) +
  geom_text(aes(label=dollar(medinc,accuracy = 1),vjust=1.5),size=3,color=&quot;white&quot;,fontface = &quot;bold&quot;)+
  theme(axis.text.y = element_blank(),axis.ticks.y = element_blank())
plot(p2 + theme(axis.text.y = element_blank()),type=&quot;cairo&quot;)

ggsave(filename=&quot;p2.png&quot;,plot=p2,device=&quot;png&quot;,height=5,width=5,units=&quot;in&quot;,dpi=500)</code></pre>
<p><BR>
<img src="p2.png" /></p>
</div>
