---
title: Sales Tax Revenue
author: Skip Krueger
date: '2020-04-30'
slug: sales-tax-revenue
description: Developing database for Texas sales tax revenue analysis
#image: img/portfolio/covmap.jpeg
categories: []
tags: []
weight: 1
---



<p>This code develops a database of Texas local government sales tax revenue.
<BR><BR><BR></p>
<div id="libraries-and-bls-api-key-handling" class="section level4">
<h4>Libraries and BLS api key handling</h4>
<p><BR>
#### You need to <a href="https://data.bls.gov/registrationEngine/" target="_blank">get an api key from BLS</a>.
<BR>
<BR></p>
<pre class="r"><code>library(RSocrata); library(tidyverse); library(RCurl); library(dplyr);
library(readr); library(dplyr); library(blsAPI); library(runner);
library(rjson); library(blscrapeR); library(skimr); library(zoo)
#set_bls_key(&quot;your-bls-api-key-goes-here&quot;)
readRenviron(&quot;~/.Renviron&quot;)
#Sys.getenv(&quot;BLS_KEY&quot;)</code></pre>
<p><BR></p>
</div>
<div id="older-sales-tax-revenue" class="section level4">
<h4>Older sales tax revenue</h4>
<p>Sales tax revenue comes from my github, where I saved the csv files I received via email from the Comptroller’s Office.</p>
<pre class="r"><code>url1 &lt;- &quot;https://raw.githubusercontent.com/skipkrueger/Data/master/TxLocalSalesTax1.csv&quot;
otx1 &lt;- read_csv(url(url1))
url2 &lt;- &quot;https://raw.githubusercontent.com/skipkrueger/Data/master/TxLocalSalesTax2.csv&quot;
otx2 &lt;- read_csv(url(url2))
otx3 &lt;- rbind(otx1,otx2)
names(otx3)[names(otx3) == &quot;TA ID&quot;] &lt;- &quot;taxid&quot;
names(otx3)[names(otx3) == &quot;TAX AUTHORITY NAME&quot;] &lt;- &quot;oldname&quot;
names(otx3)[names(otx3) == &quot;ALLOCATION MONTH&quot;] &lt;- &quot;date&quot;
names(otx3)[names(otx3) == &quot;NET PAYMENT&quot;] &lt;- &quot;amt&quot;
otx3$type &lt;- substr(otx3$taxid,1,1)
otx3 &lt;- subset(otx3, type == 2)
otx3 &lt;- filter(otx3, oldname!=&quot;OAK RIDGE&quot;)
otx3$city &lt;- if_else(otx3$taxid==2139059,&quot;RENO (LAMAR CO.)&quot;,otx3$oldname)
otx3$city &lt;- if_else(otx3$taxid==2184062,&quot;RENO (PARKER CO.)&quot;,otx3$oldname)
otx3 &lt;- subset(otx3,select = -c(oldname,type,taxid))
otx3$date &lt;- as.Date(otx3$date,&quot;%m/%d/%Y&quot;)   # NOTE THE DATE FORMAT</code></pre>
<pre class="r"><code>head(otx3)</code></pre>
<pre><code>## # A tibble: 6 x 3
##   date           amt city     
##   &lt;date&gt;       &lt;dbl&gt; &lt;chr&gt;    
## 1 1990-01-01 107681. PALESTINE
## 2 1990-02-01 304147. PALESTINE
## 3 1990-03-01 123569. PALESTINE
## 4 1990-04-01 121508. PALESTINE
## 5 1990-05-01 266375. PALESTINE
## 6 1990-06-01 156792. PALESTINE</code></pre>
<p><BR></p>
</div>
<div id="latest-sales-tax-revenue" class="section level4">
<h4>Latest sales tax revenue</h4>
<p>New sales tax revenue comes from the Texas data hub. And some clean-up.</p>
<pre class="r"><code>ntx &lt;- read.socrata(&quot;https://data.texas.gov/resource/vfba-b57j.csv&quot;)
ntx &lt;- subset(ntx, report_year==2020)
ntx &lt;- subset(ntx, report_month!=3)
ntx &lt;- subset(ntx, report_month!=2)
ntx &lt;- subset(ntx, report_month!=1)
names(ntx)[names(ntx) == &quot;net_payment_this_period&quot;] &lt;- &quot;amt&quot;
names(ntx)[names(ntx) == &quot;report_month&quot;] &lt;- &quot;month&quot;
names(ntx)[names(ntx) == &quot;report_year&quot;] &lt;- &quot;year&quot;
ntx$date &lt;- paste(ntx$month,&quot;/&quot;,&quot;1&quot;,&quot;/&quot;,ntx$year)      # NOTE THE DATE FORMAT
ntx$date &lt;- gsub(&quot; &quot;,&quot;&quot;,ntx$date)                      # NOTE THE DATE FORMAT
ntx$date &lt;- as.Date(ntx$date,&quot;%m/%d/%Y&quot;)               # NOTE THE DATE FORMAT
ntx &lt;- ntx %&gt;% mutate_each(funs(toupper),city)
ntx &lt;- subset(ntx, select = -c(comparable_payment_prior_year,
                               period_percent_change,
                               payments_to_date,
                               previous_payments_to_date,
                               ytd_percent_change,
                               report_period_type,month,year))
txall &lt;- rbind(otx3,ntx)

txall &lt;- txall %&gt;%
  group_by(city) %&gt;%
  mutate(lead = lead(amt,2))
#rm(url1,url2,otx1,otx2,otx3,ntx)        #OPTIONALLY, THE ENV CAN BE CLEANED UP</code></pre>
<pre class="r"><code>head(txall)</code></pre>
<pre><code>## # A tibble: 6 x 4
## # Groups:   city [1]
##   date           amt city         lead
##   &lt;date&gt;       &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;
## 1 1990-01-01 107681. PALESTINE 123569.
## 2 1990-02-01 304147. PALESTINE 121508.
## 3 1990-03-01 123569. PALESTINE 266375.
## 4 1990-04-01 121508. PALESTINE 156792.
## 5 1990-05-01 266375. PALESTINE 142217.
## 6 1990-06-01 156792. PALESTINE 283100.</code></pre>
<p><BR>
<BR></p>
</div>
<div id="get-the-cpi-data-from-the-bls" class="section level4">
<h4>Get the CPI data from the BLS</h4>
<p>Note that even with a bls key, it takes 2 downloads to get all the CPI data. Without the key, you have to run 4 downloads, and can only do so a couple of times before the allowable limit is reached.</p>
<pre class="r"><code>df1 &lt;- bls_api(&quot;CUSR0000SA0&quot;,startyear = 1990, endyear = 2020,registrationKey = &quot;BLS_KEY&quot;)
df2 &lt;- bls_api(&quot;CUSR0000SA0&quot;,startyear = 2010, endyear = 2020,registrationKey = &quot;BLS_KEY&quot;)
df2 &lt;- subset(df2,select = -c(latest))

infl &lt;- rbind(df1,df2)
infl &lt;- subset(infl,select = -c(footnotes,seriesID))
infl$period &lt;- substr(infl$period,2,3)
infl$date &lt;- paste(infl$period,&quot;/&quot;,&quot;1&quot;,&quot;/&quot;,infl$year)
infl$date &lt;- gsub(&quot; &quot;,&quot;&quot;,infl$date)
infl$date2 &lt;- as.Date(infl$date,&quot;%m/%d/%Y&quot;) # the key is the capital &#39;Y&#39;
infl$deflate &lt;- (259.050/infl$value)        # inflation in February </code></pre>
<pre class="r"><code>head(infl)</code></pre>
<pre><code>## # A tibble: 6 x 7
##    year period periodName value date      date2      deflate
##   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;     &lt;date&gt;       &lt;dbl&gt;
## 1  2009 12     December    217. 12/1/2009 2009-12-01    1.19
## 2  2009 11     November    217. 11/1/2009 2009-11-01    1.19
## 3  2009 10     October     217. 10/1/2009 2009-10-01    1.20
## 4  2009 09     September   216. 09/1/2009 2009-09-01    1.20
## 5  2009 08     August      215. 08/1/2009 2009-08-01    1.20
## 6  2009 07     July        215. 07/1/2009 2009-07-01    1.21</code></pre>
<p><BR></p>
</div>
<div id="join-the-data" class="section level4">
<h4>Join the data</h4>
<p><BR></p>
<pre class="r"><code>txadj &lt;- left_join(txall,infl,by=c(&quot;date&quot; = &quot;date2&quot;))</code></pre>
<p><BR></p>
</div>
<div id="adjust-for-inflation" class="section level4">
<h4>Adjust for inflation</h4>
<p><BR>
This version makes all values equivalent to February 2020 dollars. This is a bit of a pain because it means the standard changes every month, and the formula for the deflator (in the above code chunk, line 119) has to be updated and hard-coded every time. The up side to this approach is that the numbers are in the value that the average person will understand. That understanding may not mean much since the data is converted further down to percent change, so no dollar values actually appear in this version of the analysis, at this time.
<BR></p>
<pre class="r"><code>txadj$real &lt;- (txadj$deflate * txadj$lead) # real = inflation-adjusted &quot;lead&quot; revs</code></pre>
</div>
<div id="percent-change" class="section level4">
<h4>Percent change</h4>
<p>Calculate the percent change from the same month in the previous year. Note the 12 in line 157 - this stipulates the number of time units back to which the lag applies.</p>
<p>The basic approach is to generate a new column of the data of interest lagged by the specified number of time periods. And then apply the math to the contemporaneous difference between the two columns.</p>
<pre class="r"><code>tr4 &lt;- txadj %&gt;%
  group_by(city) %&gt;%
  mutate(lag = lag(real,12)) %&gt;%
  mutate(pct.change = (real - lag)/lag*100)       # pct.change = 12-month change in real </code></pre>
</div>
<div id="month-moving-average-to-calculate-the-last-4-years-average" class="section level4">
<h4>48 month moving average to calculate the last 4 years’ average</h4>
<p>At this point, I am really just interested in the average change for the last 4 years. This is a little of a complicated way to get there, but I took a rolling mean (moving average) of the last 48 months, and then just keep the latest date so that the cross section has the 4-year average for each city.</p>
<pre class="r"><code>tr4$d.ave &lt;- ave(tr4$pct.change, tr4$city, 
                  FUN= function(x) rollmean(x, k=48,align=&quot;right&quot;, na.pad=T))</code></pre>
</div>
<div id="get-just-the-latest-month-data-to-have-1-obs-with-the-4-yr-average-per-city" class="section level3">
<h3>Get just the latest month data to have 1 obs with the 4-yr average per city</h3>
<pre class="r"><code>tr5 &lt;- subset(tr4, year==2020)
tr5 &lt;- subset(tr5, period==&quot;02&quot;)</code></pre>
<div id="look-at-just-the-top-cities" class="section level4">
<h4>Look at just the top cities</h4>
<pre class="r"><code>topcities &lt;- subset(tr5, amt&gt;499000)</code></pre>
<pre class="r"><code>summary(topcities)</code></pre>
<pre><code>##       date                 amt               city                lead         
##  Min.   :2020-02-01   Min.   :  501507   Length:181         Min.   :  224712  
##  1st Qu.:2020-02-01   1st Qu.:  723177   Class :character   1st Qu.:  498445  
##  Median :2020-02-01   Median : 1327603   Mode  :character   Median :  907809  
##  Mean   :2020-02-01   Mean   : 3305265                      Mean   : 2190176  
##  3rd Qu.:2020-02-01   3rd Qu.: 3214650                      3rd Qu.: 2104128  
##  Max.   :2020-02-01   Max.   :74024289                      Max.   :50402407  
##       year         period           periodName            value      
##  Min.   :2020   Length:181         Length:181         Min.   :259.1  
##  1st Qu.:2020   Class :character   Class :character   1st Qu.:259.1  
##  Median :2020   Mode  :character   Mode  :character   Median :259.1  
##  Mean   :2020                                         Mean   :259.1  
##  3rd Qu.:2020                                         3rd Qu.:259.1  
##  Max.   :2020                                         Max.   :259.1  
##     date.y             deflate       real               lag          
##  Length:181         Min.   :1   Min.   :  224712   Min.   :  227811  
##  Class :character   1st Qu.:1   1st Qu.:  498445   1st Qu.:  514566  
##  Mode  :character   Median :1   Median :  907809   Median :  943005  
##                     Mean   :1   Mean   : 2190176   Mean   : 2273861  
##                     3rd Qu.:1   3rd Qu.: 2104128   3rd Qu.: 2162834  
##                     Max.   :1   Max.   :50402407   Max.   :51948764  
##    pct.change          d.ave       
##  Min.   :-33.993   Min.   :-5.805  
##  1st Qu.: -8.688   1st Qu.: 1.665  
##  Median : -3.803   Median : 3.094  
##  Mean   : -2.621   Mean   :   Inf  
##  3rd Qu.:  1.850   3rd Qu.: 5.354  
##  Max.   : 47.980   Max.   :   Inf</code></pre>
</div>
</div>
